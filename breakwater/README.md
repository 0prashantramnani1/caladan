# Breakwater
Breakwater is a server overload control system for
microseconds-level RPCs. This repo includes 
Shenango implementation of Breakwater as a library of
RPC layer between network transport and application.

## Supported platform
Breakwater requires an Intel server with many cores equipped
with an Intel NIC based on 82599 chip or Mellanox ConnectX-4
or ConnectX-5 NIC. For the best performance,
a low latency switch connecting server and client machines and
Mellanox NICs are required.

## Running Breakwater
1. Clone this repository to each machine.
```
$ git clone [to_be_upated]
```

2. Initialize the sub modules
```
shenango$ ./build/init_submodules.sh
```

3. Modify `build/config` according to the experiment environment.
For the best performance, set `CONFIG_DIRECTPATH=y`, but please
note that directpath is supported with Mellanox NICs.

4. If the machine is equipped with Mellanox ConnectX-4 NIC,
apply ConnectX-4 patch.
```
shenango$ git apply breakwater/build/connectx-4.patch
```

5. Build Shenango and execute the 
`breakwater/scripts/setup_machine.sh` script.
```
shenango$ make clean && make
shenango$ make -C bindings/cc
shenango$ cd breakwater
shenango/breakwater$ sudo ./scripts/setup_machine.sh
```

6. Build Breakwater and netbench application
```
shenango/breakwater$ make clean && make
shenango/breakwater$ make -C bindings/cc
shenango/breakwater$ make -C apps/netbench
```

7. Modify Shenango configuration. Sample configurations for server
and client(agent) are given in `breakwater/apps/netbench/server.config`
and `breakwater/apps/netbench/client.config`. 

8. Execute the netbench application. Server will process RPC requests which
are generated by a client and agents. If multiple client machines generate
a load, one instance becomes 'client' and others become 'agents' which
are controlled by client.
```
(At server) shenango/breakwater$ sudo ./apps/netbench/netbench [alg] server.config server
(At client) shenango/breakwater$ sudo ./apps/netbench/netbench [alg] client.config client [nclients] [server_ip] [service_us] [service_dist] [slo] [nagents] [offered_load]
(At agents) shenango/breakwater$ sudo ./apps/netbench/netbench [alg] client.config agent [client_ip]
```
- [alg]: overload control algorithms (breakwater, seda, or dagor)
- [nclients]: the number of client connections
- [server\_ip]: server IP Address
- [service\_us]: average request processing time (in us)
- [service\_dist]: request processing time distribution (exp, const, or bimod)
- [slo]: RPC service level objective (in us)
- [nagnets]: the number of agents
- [offered\_load]: load geneated by client and agents in request per second.

## Quick Start (with Cloudlab XL170)
If you have access to the Cloudlab, you can simply follow the
instruction below to reproduce the results in the paper.
Please note that Breakwater performance may vary based on the
topologies of the servers. It produces the best performance
when all the servers are connected to a single switch.

1. Launch the Cloudlab experiment with multiple bare-metal
machines. You can see the sample Cloudlab profile [here](
https://www.cloudlab.us/p/CreditRPC/breakwater-five-xl170)
consisting of five machines.
You can use pre-built Cloudlab disk image (URN:
urn:publicid:IDN+utah.cloudlab.us+image+creditrpc-PG0:shenango-ready-xl170)
which is Ubuntu 18.04 LTS with Mellanox OFED driver and
dependencies installed. [For artifact evaluators] If you
don't have access to the Cloudlab and need one, we can provide
the SSH access to the experiment after we launch one.
However, please note that an experiment expires after 16 hours,
so you will need to make another request to us after it expires.
Further, as Cloudlab is shared with other researchers, its
availability is not guaranteed.

2. Once you create an experiment, clone this repository to
each machine.
```
$ git clone [to_be_updated]
```

3. At the observer machine (this could be one of server, client,
agents machines, or ideally, a separate machine), provide the SSH
information of machines in `scripts/config_remote.py`, and execute
`scripts/configure_xl170.py`. Server will process RPC requests which
are generated by a client and agents. The client controls agents to
generate the load synchronously. If only a single machine generates
a load, `AGENTS` can be an empty list.
```
shenango/breakwater$ python3 scripts/configure_xl170.py
```

4. You can execute `scripts/run_synthetic.py` to experiment with
synthetic workload. Default experiment scripts is for breakwater
with 1,000 clients, 10 us average service time which is
exponentially distributed. Once an experiment finished, you can
see the csv-formatted output in `outputs` directory. Modify the
configuration of experiment script for different overload control
mechanisms, average service time, service time distribution, and
the number of clients.
```
shenango/breakwater$ python3 scripts/run_synthetic.py
```
